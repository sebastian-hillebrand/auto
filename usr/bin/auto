#!/usr/bin/php
<?php ob_start(); ?>

Auto is a collection of scripts to automate as much as possible tasks
by designing conventions and workflows for a better administrator,
developer and user experience.

    Usage: auto <command> [<context> [<target> [<event>]]]

At the moment you should not use these scripts if you have not been
told to do so. They are in a very early stage of development.

http://proojekte.github.io/auto/

<?php

// If nothing meaningful happens
// $output will be the text on top of this file,
// $return will indicate an error
// and no automation script will be run.
$output = ob_get_contents(); ob_end_clean();
$return = 1;
$path = '';

// Load functions
require('/usr/share/auto/functions.php');

// Get $params
$command_type = get_command_type($argv);
$command      = get_command($argv);
$context_type = get_context_type($argv);
$context      = get_context($argv);
$target_type  = get_target_type($argv);
$target       = get_target($argv);
$event_type   = get_event_type($argv);
$event        = get_event($argv);

// If help is wanted
// don't run any automation scripts
// and return no error code.
switch ($command)
{
    case 'help':
    case '--help':
    case '-help':
    case '-h':
    case '-?':
        $command = '';
        $return = 0;
}

// Get $path
$path = get_path($command, $context, $context_type);

// Run the automation script if readable.
// Otherwise return an error.
if ($path <> '')
{
    $script = '/usr/share/auto/' . $path . '.php';

    if (is_readable($script))
    {
        include $script;
    }
    else
    {
        $output = 'Error: Script "' . $script . '" is not readable.';
    }
}

// Convert $output to a string if it is an array.
if (is_array($output))
{
    $output = implode("\n", $output);
}

// Generate $log.
$log = '/var/log/auto/' . $path;

// Mkdir if $log does not exist.
if (!file_exists($log))
{
    mkdir($log, 0770, true);
}

// Write $output to logfile if $log is writeable.
if (is_writeable($log))
{
    file_put_contents($log . '/' . date("Y-m-d.H-i-s") . '.log', $output, FILE_APPEND);
}
else
{
    $output = "\n" . 'Warning: Log "' . $log . '" is not writeable.' . "\n\n" . $output;
}

// Check if $output does not end with a new line character.
// Then return $output plus a new line character.
// Otherwise return $output as it is.
if (substr($output, -1) != "\n")
{
    echo $output . "\n";
}
else
{
    echo $output;
}

// Exit this script.
exit($return);
